<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reproductor Multimedia Táctil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Variables --- */
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent-color: #1DB954; /* Spotify Green - Buen contraste */
            --error-color: #CF6679;
            --success-color: #2ECC71;
            --favorite-color: #FFD700;
            --unknown-color: #616161; /* Color para estado desconocido (gris) */
            --border-color: #333333;
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --spacing-unit: 8px;
            --header-height: 60px;
            --footer-height: 70px;
            --button-min-size: 48px; /* Tamaño mínimo táctil */
        }

        /* --- Estilos Globales --- */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; /* Evitar highlight azul en tap */ }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px; /* Tamaño base más grande para legibilidad */
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            -webkit-touch-callout: none; /* Deshabilitar callouts */
            -webkit-user-select: none;   /* Deshabilitar selección de texto */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* Internet Explorer/Edge */
            user-select: none;         /* Non-prefixed version */
        }

        /* --- Layout Principal --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Ocupar toda la altura */
        }

        /* --- Cabecera --- */
        .app-header {
            height: var(--header-height);
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between; /* Cambiado para logo y botón atrás */
            padding: 0 calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .app-header .back-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px; /* Más grande */
            cursor: pointer;
            padding: var(--spacing-unit);
            display: none; /* Oculto por defecto */
            min-width: var(--button-min-size);
            min-height: var(--button-min-size);
            /* display: flex; */ /* Se controla con .visible */
            align-items: center;
            justify-content: center;
        }
         .app-header .back-button.visible {
             display: flex; /* Mostrar cuando sea necesario */
         }
        .app-header .logo img {
             height: 40px;
             object-fit: contain;
             margin: 0 auto; /* Centrar logo si no hay botón atrás */
        }
        .app-header .logo.with-back-button img {
            margin: 0; /* Alinear a la izquierda cuando hay botón atrás */
        }
        /* Espacio para equilibrar el botón de volver */
        .header-spacer {
             width: var(--button-min-size);
             height: var(--button-min-size);
             flex-shrink: 0;
        }


        /* --- Contenido Principal --- */
        .app-main {
            flex-grow: 1;
            overflow-y: auto; /* Scroll principal */
            overflow-x: hidden;
            /* Quitar padding para que el fondo de la vista ocupe todo */
            /* padding: calc(var(--spacing-unit) * 2); */
            position: relative; /* Para el overlay de carga */
        }
        /* Estilo scrollbar (opcional, puede ser menos visible en táctil) */
        .app-main::-webkit-scrollbar { width: 6px; }
        .app-main::-webkit-scrollbar-track { background: transparent; }
        .app-main::-webkit-scrollbar-thumb { background-color: var(--bg-tertiary); border-radius: 3px; }

        /* --- Vistas (Secciones) --- */
        .view {
            display: none;
            padding: calc(var(--spacing-unit) * 2); /* Añadir padding interno a las vistas */
            height: 100%; /* Asegurar que la vista activa ocupa el espacio */
            overflow-y: auto; /* Permitir scroll dentro de la vista si es necesario */
        }
        .view.active { display: block; }

        /* --- Vista Menú Principal --- */
        #mainMenuView {
            /* Imagen de fondo */
            background-image: url('https://d2t1xqejof9utc.cloudfront.net/screenshots/pics/5a713433010f81e5b52534d932f73905/large.png');
            /* background-size: contain; */ /* Hacer que la imagen quepa completa */
            background-size: 80% auto; /* AJUSTE: Imagen ocupa 80% del ancho, altura automática */
            background-position: center; /* Centrar la imagen */
            background-repeat: no-repeat; /* No repetir la imagen */
            /* Añadir un overlay semi-transparente para mejorar legibilidad */
            position: relative; /* Necesario para el pseudo-elemento */
            z-index: 1; /* Asegurar que está debajo del contenido */
            background-color: var(--bg-primary); /* Color de fondo si la imagen no cubre todo */
        }
        /* Overlay para mejorar contraste */
        #mainMenuView::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Negro semi-transparente */
            z-index: -1; /* Detrás del contenido de la vista */
            border-radius: inherit; /* Heredar redondeo si se aplica a .view */
        }

        #mainMenuView .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Columnas adaptables */
            gap: calc(var(--spacing-unit) * 2);
            padding: calc(var(--spacing-unit) * 2) 0; /* Padding vertical */
            position: relative; /* Para que esté sobre el overlay */
            z-index: 2;
        }
        .menu-button {
            background-color: rgba(30, 30, 30, 0.8); /* Fondo semi-transparente para botones */
            border: 1px solid rgba(51, 51, 51, 0.8); /* Borde semi-transparente */
            color: var(--text-primary);
            padding: calc(var(--spacing-unit) * 3) calc(var(--spacing-unit) * 2); /* Más padding */
            border-radius: var(--border-radius-md);
            font-size: 1.2em; /* Texto más grande */
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-unit);
            min-height: 120px; /* Altura mínima */
            backdrop-filter: blur(2px); /* Efecto blur ligero (opcional) */
            -webkit-backdrop-filter: blur(2px);
        }
        .menu-button i {
            font-size: 2em; /* Icono grande */
            margin-bottom: var(--spacing-unit);
        }
        .menu-button:hover { background-color: rgba(42, 42, 42, 0.9); } /* Hover más opaco */
        .menu-button:active { transform: scale(0.97); } /* Feedback táctil */

        /* --- Vista Lista de Contenido (TV, Series, Películas, Favoritos) --- */
        .content-list-view h2 {
            font-size: 1.5em;
            margin-bottom: calc(var(--spacing-unit) * 2);
            color: var(--text-primary);
        }
        .search-bar {
            display: flex;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }
        .search-bar input {
            flex-grow: 1;
            padding: calc(var(--spacing-unit) * 1.5);
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 1em;
            outline: none;
        }
        .search-bar input:focus { border-color: var(--accent-color); }
        .search-bar button {
            padding: 0 calc(var(--spacing-unit) * 2);
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-left: none;
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
            color: var(--text-secondary);
            font-size: 1.2em;
            cursor: pointer;
            min-width: var(--button-min-size);
        }
         .search-bar button:hover { background-color: var(--border-color); color: var(--text-primary); }

        .item-grid { /* Reutilizado para series/películas */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* Ajustar tamaño mínimo */
            gap: calc(var(--spacing-unit) * 2);
        }
        .item-card { /* Reutilizado para series/películas */
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            flex-direction: column;
        }
        .item-card:hover { background-color: var(--bg-tertiary); }
        .item-card:active { transform: scale(0.97); }
        .item-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 2 / 3; /* Poster */
            display: block;
            background-color: var(--bg-tertiary);
        }
        .item-card .text-content {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            flex-grow: 1;
        }
        .item-card h3 {
            font-size: 1em;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.3;
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            /* Limitar a 2 líneas */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: calc(1.3em * 2);
        }

        .channel-list { /* Para TV y Favoritos */
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .channel-list-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-secondary);
            padding: calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-unit);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            gap: calc(var(--spacing-unit) * 1.5);
        }
        .channel-list-item:hover { background-color: var(--bg-tertiary); }
        .channel-list-item:active { transform: scale(0.98); }
        .channel-list-item.active { background-color: var(--bg-tertiary); border-left: 4px solid var(--accent-color); padding-left: calc(var(--spacing-unit) * 1.5 - 4px); }
        .channel-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background-color: var(--bg-tertiary);
            flex-shrink: 0;
        }
        .channel-list-item .channel-details {
            overflow: hidden; /* Para ellipsis */
            flex-grow: 1;
        }
        .channel-list-item .channel-title {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* Asegurar que ocupa el ancho */
        }
        .channel-list-item .channel-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* Asegurar que ocupa el ancho */
        }
        .channel-list-item .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--unknown-color);
            flex-shrink: 0;
            margin-left: auto; /* Empujar a la derecha */
            transition: background-color 0.3s ease;
        }
        .channel-list-item .status-dot.online { background-color: var(--success-color); }
        .channel-list-item .status-dot.offline { background-color: var(--error-color); }

        /* --- Vista Reproductor (Común para TV, Series, Películas) --- */
        #playerView {
            height: 100%; /* Ocupar todo el espacio de .app-main */
            display: flex;
            flex-direction: column;
            padding: 0; /* Quitar padding para que el player ocupe todo */
            overflow: hidden; /* Evitar scroll dentro de la vista player */
        }
        .player-area {
            flex-grow: 1; /* Ocupa la mayor parte del espacio */
            background-color: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0; /* Sin redondeo para ocupar todo */
            overflow: hidden;
        }
        .player-area video, .player-area iframe {
            width: 100%;
            height: 100%;
            display: block;
            border: none;
        }
        .player-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            background-color: rgba(0,0,0,0.7);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius-sm);
            text-align: center;
        }

        /* Contenedor de info/controles específicos (debajo del player) */
        .player-info-controls {
            padding: calc(var(--spacing-unit) * 1.5); /* Añadir padding aquí */
            flex-shrink: 0;
            display: flex;
            flex-direction: column; /* Apilar info y controles */
            gap: var(--spacing-unit);
            background-color: var(--bg-primary); /* Fondo para separar del player */
        }

        /* Info del contenido (Título, descripción opcional) */
        .content-info h3 {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: calc(var(--spacing-unit) * 0.5);
        }
        .content-info p {
            font-size: 0.9em;
            color: var(--text-secondary);
            /* Limitar descripción si es muy larga */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Controles específicos (Favoritos TV, Temporadas/Episodios Series) */
        .specific-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            flex-wrap: wrap; /* Para que quepan en pantallas pequeñas */
        }

        /* Botón Favorito (para TV) */
        .favorite-button {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 1.5em; /* Icono grande */
            border-radius: 50%;
            cursor: pointer;
            width: var(--button-min-size);
            height: var(--button-min-size);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease, background-color 0.2s ease;
        }
        .favorite-button.is-favorite {
            color: var(--favorite-color);
            background-color: var(--bg-tertiary);
        }
        .favorite-button:hover {
            background-color: var(--bg-tertiary);
        }
        .favorite-button:active {
             transform: scale(0.95);
        }

        /* Selectores de Temporada/Episodio (para Series) */
        .season-episode-selectors {
            display: flex;
            gap: var(--spacing-unit);
            flex-wrap: wrap;
        }
        .season-episode-selectors select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: calc(var(--spacing-unit) * 1.2) calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius-sm);
            font-size: 1em;
            min-width: 120px; /* Ancho mínimo */
            cursor: pointer;
            outline: none;
        }
        .season-episode-selectors select:focus {
            border-color: var(--accent-color);
        }


        /* --- Overlay de Carga y Error --- */
        .loading-overlay, .error-overlay-car {
            position: absolute; /* Cambiado a absolute para que quede dentro de .app-main */
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Oculto por defecto */
            align-items: center;
            justify-content: center;
            z-index: 1500;
            padding: calc(var(--spacing-unit) * 3);
            text-align: center;
            flex-direction: column; /* Para error */
            /* border-radius: var(--border-radius-md); */ /* Quitar redondeo, ocupa todo .app-main */
        }
        .loading-overlay.visible, .error-overlay-car.visible {
            display: flex;
        }
        .spinner {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-unit);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-overlay-car .error-message {
            color: var(--error-color);
            font-size: 1.1em;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }
        .error-overlay-car .error-buttons {
            display: flex;
            gap: var(--spacing-unit);
            flex-wrap: wrap; /* Para que quepan botones en pantallas pequeñas */
            justify-content: center;
        }
        .error-overlay-car .error-button {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
        }
        .error-overlay-car .error-button:hover {
            background-color: var(--border-color);
        }

        /* --- Responsividad Simple --- */
        @media (max-width: 600px) {
            :root {
                --header-height: 50px;
                --footer-height: 60px;
                --spacing-unit: 6px;
                --button-min-size: 44px;
            }
            body { font-size: 15px; }
            .app-header .logo img { height: 35px; }
            #mainMenuView .menu-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--spacing-unit); }
            .menu-button { padding: calc(var(--spacing-unit) * 2); font-size: 1.1em; min-height: 100px; }
            .menu-button i { font-size: 1.8em; }
            .item-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: var(--spacing-unit); }
            .item-card h3 { font-size: 0.95em; min-height: calc(1.3em * 2); }
            .channel-list-item { padding: var(--spacing-unit); gap: var(--spacing-unit); }
            .channel-list-item img { width: 40px; height: 40px; }
            .channel-list-item .channel-title { font-size: 1em; }
            .channel-list-item .channel-desc { font-size: 0.85em; }
            .content-info h3 { font-size: 1.1em; }
            .content-info p { font-size: 0.85em; }
            .season-episode-selectors select { font-size: 0.9em; min-width: 100px; padding: var(--spacing-unit); }
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <button class="back-button" id="backButton" aria-label="Volver">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="logo" id="logoContainer">
                 <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjtH1eFwNcBk9FvfM8ozeG6zjDtvJR2j2CdfNtfn8rj0JP9PRWR7zeL_ayD_dwmmuqOe8-sTp-TcOGCVsg5yhUNBO_PqRVI9gCMu3B1x2MQ1ZsitAg-1NKxQ70x3H-O9eehSCsQO6DzLPxcB_uZpfGmfziYNcXQ0JylvrGY1PE-sc9nJ76l2c62PG3Kcvs/w683-h203/JORGEDEZ-19-3-2025.png"
                      alt="Logo JORGEDEZ"
                      onerror="this.onerror=null; this.style.display='none';">
            </div>
            <div class="header-spacer"></div>
        </header>

        <main class="app-main">
            <div id="mainMenuView" class="view active">
                <div class="menu-grid">
                    <button class="menu-button" data-target-view="tvListView">
                        <i class="fas fa-tv"></i>
                        <span>TV en Vivo</span>
                    </button>
                    <button class="menu-button" data-target-view="seriesListView">
                        <i class="fas fa-video"></i>
                        <span>Series</span>
                    </button>
                    <button class="menu-button" data-target-view="moviesListView">
                        <i class="fas fa-film"></i>
                        <span>Películas</span>
                    </button>
                    <button class="menu-button" data-target-view="favoritesListView">
                        <i class="fas fa-star"></i>
                        <span>Favoritos (TV)</span>
                    </button>
                </div>
            </div>

            <div id="tvListView" class="view content-list-view">
                <h2>TV en Vivo</h2>
                <div class="search-bar">
                    <input type="text" id="tvSearchInput" placeholder="Buscar canal..." aria-label="Buscar canal de TV">
                    <button id="tvSearchButton" aria-label="Buscar"><i class="fas fa-search"></i></button>
                </div>
                <ul class="channel-list" id="tvChannelList">
                    </ul>
            </div>

            <div id="seriesListView" class="view content-list-view">
                <h2>Series</h2>
                <div class="item-grid" id="seriesGrid">
                    </div>
            </div>

            <div id="moviesListView" class="view content-list-view">
                <h2>Películas</h2>
                <div class="item-grid" id="moviesGrid">
                    </div>
            </div>

            <div id="favoritesListView" class="view content-list-view">
                <h2>Favoritos (TV)</h2>
                <ul class="channel-list" id="favoritesChannelList">
                    </ul>
            </div>

            <div id="playerView" class="view">
                <div class="player-area">
                    <video id="hlsPlayer" playsinline webkit-playsinline crossorigin="anonymous" controls style="display: none;"></video>
                    <iframe id="drivePlayer" src="about:blank" allow="autoplay; fullscreen" style="display: none;"></iframe>
                    <div class="player-message" id="playerMessageElement">Cargando...</div>
                </div>
                <div class="player-info-controls">
                    <div class="content-info">
                        <h3 id="playerContentTitle">Título</h3>
                        <p id="playerContentDescription">Descripción...</p>
                    </div>
                    <div class="specific-controls">
                        <button id="playerFavoriteButton" class="favorite-button" aria-label="Añadir a favoritos" style="display: none;">
                            <i class="fas fa-star"></i>
                        </button>
                        <div id="playerSeriesSelectors" class="season-episode-selectors" style="display: none;">
                            <select id="seasonSelector" aria-label="Seleccionar temporada"></select>
                            <select id="episodeSelector" aria-label="Seleccionar episodio"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <span id="loadingMessage">Cargando...</span>
            </div>

        </main>

         </div>

    <div class="error-overlay-car" id="errorOverlayCar">
        <div class="error-message" id="errorMessageCar">Error</div>
        <div class="error-buttons" id="errorButtonsCar">
            <button class="error-button" id="closeErrorCarButton">Cerrar</button>
        </div>
    </div>

    <script>
    // Envolver en try...catch global
    try {
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Cargado - Reproductor Táctil");

            // --- URLs de Datos ---
            const M3U_URL = 'https://raw.githubusercontent.com/sejo48/chanejorgedez/refs/heads/main/listaoficial.m3u';
            const SERIES_JSON_URL = "https://raw.githubusercontent.com/sejo48/jorgedrive/refs/heads/main/playlist.json";
            const MOVIES_JSON_URL = "https://raw.githubusercontent.com/sejo48/peliculas/refs/heads/main/peliculas.json";

            // --- Estado de la Aplicación ---
            let currentView = 'mainMenuView';
            let previousView = null;
            let tvChannels = [];
            let seriesData = [];
            let moviesData = [];
            let tvFavorites = JSON.parse(localStorage.getItem('favoritesTvChannelsCar') || '[]');
            let tvChannelStatuses = JSON.parse(localStorage.getItem('channelStatusesTvPlayerCar') || '{}');
            let hlsInstance = null;
            let currentPlayingTvChannelIndex = null;
            let currentPlayingSeries = null; // { seriesIndex, seasonNumber, episodeIndex }
            let currentPlayingMovieIndex = null;

            // --- Referencias a Elementos DOM ---
            // CORRECCIÓN: Usar los IDs exactos del HTML
            const views = {
                mainMenuView: document.getElementById('mainMenuView'),
                tvListView: document.getElementById('tvListView'),
                seriesListView: document.getElementById('seriesListView'),
                moviesListView: document.getElementById('moviesListView'),
                favoritesListView: document.getElementById('favoritesListView'),
                playerView: document.getElementById('playerView'), // Corregido
            };
            const backButton = document.getElementById('backButton');
            const logoContainer = document.getElementById('logoContainer');
            const tvChannelListElement = document.getElementById('tvChannelList');
            const tvSearchInput = document.getElementById('tvSearchInput');
            const tvSearchButton = document.getElementById('tvSearchButton');
            const seriesGridElement = document.getElementById('seriesGrid');
            const moviesGridElement = document.getElementById('moviesGrid');
            const favoritesChannelListElement = document.getElementById('favoritesChannelList');
            const hlsPlayerElement = document.getElementById('hlsPlayer');
            const drivePlayerElement = document.getElementById('drivePlayer');
            const playerMessageElement = document.getElementById('playerMessageElement');
            const playerContentTitle = document.getElementById('playerContentTitle');
            const playerContentDescription = document.getElementById('playerContentDescription');
            const playerFavoriteButton = document.getElementById('playerFavoriteButton');
            const playerSeriesSelectors = document.getElementById('playerSeriesSelectors');
            const seasonSelector = document.getElementById('seasonSelector');
            const episodeSelector = document.getElementById('episodeSelector');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorOverlayCar = document.getElementById('errorOverlayCar');
            const errorMessageCar = document.getElementById('errorMessageCar');
            const errorButtonsCar = document.getElementById('errorButtonsCar');
            const closeErrorCarButton = document.getElementById('closeErrorCarButton');

            // --- Verificación Inicial de Elementos Críticos ---
            // Añadir verificación para los IDs corregidos
            if (!backButton || !logoContainer || !tvChannelListElement || !seriesGridElement || !moviesGridElement || !favoritesChannelListElement || !hlsPlayerElement || !drivePlayerElement || !playerMessageElement || !loadingOverlay || !errorOverlayCar || !Object.values(views).every(v => v)) {
                console.error("Error crítico: Faltan elementos esenciales de la interfaz.");
                alert("Error al cargar la interfaz. Faltan elementos.");
                return;
            }

            // --- Lógica de Navegación ---
            function navigateTo(viewId, data = null) {
                console.log(`Navegando a: ${viewId}`);
                // CORRECCIÓN: Usar el ID directamente
                const targetView = document.getElementById(viewId);
                if (!targetView) {
                     console.error(`Vista con ID ${viewId} no encontrada.`);
                     // Intentar buscar por la clave original si falla el ID (fallback temporal)
                     const fallbackView = views[viewId]; // Buscar por clave como antes
                     if(fallbackView) {
                         console.warn(`Fallback: Usando clave '${viewId}' en lugar de ID.`);
                         // Ya no necesitamos asignar a targetView aquí, se usa directamente el elemento encontrado
                     } else {
                         return; // Realmente no se encontró
                     }
                }

                // Si no se encontró por ID, usar el fallback si existe
                const viewToShow = targetView || views[viewId];
                if (!viewToShow) {
                    console.error(`Vista '${viewId}' no encontrada ni por ID ni por clave.`);
                    return;
                }


                previousView = currentView;
                currentView = viewId; // Guardar el ID de la vista actual

                // Ocultar todas las vistas (usando los IDs del HTML)
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));

                // Mostrar la vista destino
                viewToShow.classList.add('active'); // Usar el elemento encontrado

                // Configurar botón de volver y logo
                if (viewId === 'mainMenuView') {
                    backButton.classList.remove('visible');
                    logoContainer.classList.remove('with-back-button');
                } else {
                    backButton.classList.add('visible');
                    logoContainer.classList.add('with-back-button');
                }

                // Detener reproductores si salimos de la vista de reproducción
                // CORRECCIÓN: Usar el ID guardado en previousView
                if (previousView === 'playerView' && viewId !== 'playerView') {
                    stopPlayback();
                }

                // Cargar datos si es necesario al entrar a una vista de lista
                switch (viewId) {
                    case 'tvListView':
                        if (tvChannels.length === 0) loadTvChannels();
                        else renderTvChannelList(tvChannels);
                        break;
                    case 'seriesListView':
                        if (seriesData.length === 0) loadSeries();
                        break;
                    case 'moviesListView':
                        if (moviesData.length === 0) loadMovies();
                        break;
                    case 'favoritesListView':
                        renderFavoritesList();
                        break;
                    case 'playerView': // CORREGIDO: Usar el ID
                        if (data) setupPlayerView(data);
                        break;
                }

                // Scroll al inicio de la nueva vista
                document.querySelector('.app-main')?.scrollTo(0, 0);
            }

            // --- Lógica de Carga y Renderizado ---

            function showLoading(message = "Cargando...") {
                if (loadingOverlay && loadingMessage) {
                    loadingMessage.textContent = message;
                    loadingOverlay.classList.add('visible');
                }
            }

            function hideLoading() {
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('visible');
                }
            }

            function showError(message, buttonsConfig = []) {
                 console.error("Mostrando error:", message);
                 if (errorOverlayCar && errorMessageCar && errorButtonsCar) {
                     errorMessageCar.textContent = message;
                     // Limpiar botones anteriores (excepto el de cerrar)
                     while (errorButtonsCar.firstChild && errorButtonsCar.firstChild !== closeErrorCarButton) {
                         errorButtonsCar.removeChild(errorButtonsCar.firstChild);
                     }
                     // Añadir nuevos botones
                     buttonsConfig.forEach(config => {
                         const button = document.createElement('button');
                         button.className = 'error-button';
                         button.textContent = config.text;
                         button.onclick = () => {
                             hideError();
                             if (config.action) config.action();
                         };
                         // Insertar antes del botón de cerrar
                         errorButtonsCar.insertBefore(button, closeErrorCarButton);
                     });
                     errorOverlayCar.classList.add('visible');
                 } else {
                     alert(`Error: ${message}`); // Fallback
                 }
             }

            function hideError() {
                if (errorOverlayCar) {
                    errorOverlayCar.classList.remove('visible');
                }
            }

            // --- TV ---
            async function loadTvChannels() {
                showLoading("Cargando canales de TV...");
                try {
                    const response = await fetch(M3U_URL, { cache: "no-store" });
                    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                    const m3uText = await response.text();
                    tvChannels = parseM3U(m3uText);
                    console.log(`Canales de TV parseados: ${tvChannels.length}`);
                    if (tvChannels.length === 0) {
                         showError("No se encontraron canales de TV válidos en la lista.", [{ text: "Recargar", action: loadTvChannels }]);
                    } else {
                         renderTvChannelList(tvChannels);
                    }
                } catch (error) {
                    console.error('Error cargando/parseando M3U:', error);
                    showError(`Error al cargar canales: ${error.message}`, [{ text: "Reintentar", action: loadTvChannels }]);
                    tvChannels = [];
                    renderTvChannelList([]); // Mostrar lista vacía
                } finally {
                    hideLoading();
                }
            }

            function parseM3U(m3uText) {
                 const lines = m3uText.split(/[\r\n]+/);
                 const parsedChannels = [];
                 let currentChannelInfo = null;
                 const extinfRegex = /#EXTINF:(-?\d+)(.*)/;
                 const attributeRegex = /(\S+?)=(?:"([^"]*)"|([^ ]*))/g;
                 const titleCommaRegex = /,(?!")(.*)/;

                 for (const line of lines) {
                     const trimmedLine = line.trim();
                     if (!trimmedLine || trimmedLine === '#EXTM3U') continue;

                     if (trimmedLine.startsWith('#EXTINF:')) {
                         const match = trimmedLine.match(extinfRegex);
                         if (match) {
                             currentChannelInfo = { duration: match[1], attributes: {}, title: '', logo: '', url: '', description: '' };
                             const restOfLine = match[2] || '';
                             let attrMatch;
                             while ((attrMatch = attributeRegex.exec(restOfLine)) !== null) {
                                 currentChannelInfo.attributes[attrMatch[1].toLowerCase()] = attrMatch[2] !== undefined ? attrMatch[2] : attrMatch[3];
                             }
                             currentChannelInfo.title = (currentChannelInfo.attributes['tvg-name'] || '').trim();
                             if (!currentChannelInfo.title) {
                                 const titleMatch = restOfLine.match(titleCommaRegex);
                                 if (titleMatch && titleMatch[1]) {
                                     currentChannelInfo.title = titleMatch[1].trim();
                                 }
                             }
                             if (!currentChannelInfo.title) { currentChannelInfo.title = 'Canal Desconocido'; }
                             currentChannelInfo.logo = currentChannelInfo.attributes['tvg-logo'] || '';
                             currentChannelInfo.description = currentChannelInfo.attributes['group-title'] || currentChannelInfo.title || ''; // Usar group-title o title como descripción
                         } else {
                             currentChannelInfo = null; // Resetear si la línea EXTINF es inválida
                         }
                     } else if (currentChannelInfo && !trimmedLine.startsWith('#')) {
                         currentChannelInfo.url = trimmedLine;
                         if (currentChannelInfo.url) {
                             parsedChannels.push(currentChannelInfo);
                         }
                         currentChannelInfo = null; // Resetear después de añadir la URL
                     }
                 }
                 return parsedChannels;
             }

            function renderTvChannelList(channelsToRender, targetElement = tvChannelListElement) {
                if (!targetElement) return;
                targetElement.innerHTML = ''; // Limpiar lista

                if (!channelsToRender || channelsToRender.length === 0) {
                    targetElement.innerHTML = `<li style="color: var(--text-secondary); text-align: center; padding: calc(var(--spacing-unit) * 4) 0;">${targetElement === favoritesChannelListElement ? 'No hay favoritos.' : 'No se encontraron canales.'}</li>`;
                    return;
                }

                // Ordenar: Favoritos primero, luego alfabéticamente
                const sortedChannels = [...channelsToRender].sort((a, b) => {
                    const aIndex = tvChannels.findIndex(ch => ch.url === a.url);
                    const bIndex = tvChannels.findIndex(ch => ch.url === b.url);
                    const aIsFavorite = tvFavorites.includes(aIndex.toString());
                    const bIsFavorite = tvFavorites.includes(bIndex.toString());

                    if (targetElement !== favoritesChannelListElement) { // No ordenar por favorito en la lista de favoritos
                        if (aIsFavorite && !bIsFavorite) return -1;
                        if (!aIsFavorite && bIsFavorite) return 1;
                    }
                    return (a.title || '').localeCompare(b.title || '');
                });


                const fragment = document.createDocumentFragment();
                sortedChannels.forEach(channel => {
                    const originalIndex = tvChannels.findIndex(ch => ch.url === channel.url);
                    if (originalIndex === -1) return; // Canal no encontrado en la lista original

                    const li = document.createElement('li');
                    li.className = 'channel-list-item';
                    li.dataset.channelIndex = originalIndex; // Guardar índice original

                    const img = document.createElement('img');
                    const placeholderText = encodeURIComponent((channel.title || '?').charAt(0));
                    img.src = channel.logo || `https://placehold.co/50x50/383838/aaaaaa?text=${placeholderText}`;
                    img.alt = ''; // Decorativo
                    img.onerror = () => { img.src = `https://placehold.co/50x50/383838/aaaaaa?text=${placeholderText}`; img.alt = `Placeholder ${channel.title || 'Canal'}`; };
                    img.loading = 'lazy';

                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'channel-details';

                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'channel-title';
                    titleSpan.textContent = channel.title || 'Canal sin título';

                    const descSpan = document.createElement('span');
                    descSpan.className = 'channel-desc';
                    descSpan.textContent = channel.description || ''; // Mostrar descripción

                    detailsDiv.appendChild(titleSpan);
                    detailsDiv.appendChild(descSpan);

                    const statusDot = document.createElement('span');
                    const currentStatus = tvChannelStatuses[originalIndex];
                    statusDot.className = `status-dot ${currentStatus || ''}`;
                    const statusTitle = currentStatus === 'online' ? 'En línea' : currentStatus === 'offline' ? 'Fuera de línea' : 'Estado desconocido';
                    statusDot.title = statusTitle;

                    li.appendChild(img);
                    li.appendChild(detailsDiv);
                    li.appendChild(statusDot);

                    li.addEventListener('click', () => {
                        // CORREGIDO: Usar el ID de la vista del reproductor
                        navigateTo('playerView', { type: 'tv', index: originalIndex });
                    });

                    fragment.appendChild(li);
                });
                targetElement.appendChild(fragment);

                // Resaltar canal actual si está en esta lista
                if (currentPlayingTvChannelIndex !== null) {
                     highlightPlayingChannel(currentPlayingTvChannelIndex, targetElement);
                }
            }

            function renderFavoritesList() {
                 const favoriteChannelsData = tvChannels.filter((channel, index) => tvFavorites.includes(index.toString()));
                 renderTvChannelList(favoriteChannelsData, favoritesChannelListElement);
             }

            function filterAndRenderTvChannels() {
                const searchTerm = tvSearchInput.value.toLowerCase().trim();
                const filtered = tvChannels.filter(channel =>
                    (channel.title && channel.title.toLowerCase().includes(searchTerm)) ||
                    (channel.description && channel.description.toLowerCase().includes(searchTerm))
                );
                renderTvChannelList(filtered);
            }

            function updateTvChannelStatus(index, status) {
                 if (index === null || index < 0 || index >= tvChannels.length) return;
                 const previousStatus = tvChannelStatuses[index];
                 if (previousStatus !== status) {
                     tvChannelStatuses[index] = status;
                     localStorage.setItem('channelStatusesTvPlayerCar', JSON.stringify(tvChannelStatuses));
                     console.log(`Estado TV actualizado para ${index}: ${status}`);
                     // Actualizar punto en ambas listas
                     updateStatusDotInElement(tvChannelListElement, index, status);
                     updateStatusDotInElement(favoritesChannelListElement, index, status);
                 }
             }

            function updateStatusDotInElement(listElement, index, status) {
                 if (!listElement) return;
                 const listItem = listElement.querySelector(`li[data-channel-index="${index}"]`);
                 if (listItem) {
                     const dot = listItem.querySelector('.status-dot');
                     if (dot) {
                         dot.className = `status-dot ${status || ''}`;
                         const statusTitle = status === 'online' ? 'En línea' : status === 'offline' ? 'Fuera de línea' : 'Estado desconocido';
                         dot.title = statusTitle;
                     }
                 }
             }

            function highlightPlayingChannel(index, listElement) {
                 if (!listElement) return;
                 listElement.querySelectorAll('li.active').forEach(li => li.classList.remove('active'));
                 const activeItem = listElement.querySelector(`li[data-channel-index="${index}"]`);
                 if (activeItem) {
                     activeItem.classList.add('active');
                     // No hacer scrollIntoView automáticamente en táctil, puede ser molesto
                 }
             }

            // --- Series ---
            async function loadSeries() {
                showLoading("Cargando series...");
                seriesGridElement.innerHTML = ''; // Limpiar grid
                try {
                    const response = await fetch(SERIES_JSON_URL, { cache: "no-store", headers: { 'Accept': 'application/json' } });
                    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                    let data = await response.json();
                    if (!Array.isArray(data)) throw new Error("Formato de datos de series inválido.");
                    // Filtrar las que NO son series (igual que antes)
                    seriesData = data.filter(item =>
                         item && item.tituloSerie &&
                         !item.tituloSerie.toLowerCase().includes('película') &&
                         item.tituloSerie !== 'Encanto'
                     );
                    console.log(`Series cargadas y filtradas: ${seriesData.length}`);
                    renderSeriesList(seriesData);
                     if (seriesData.length === 0) {
                         seriesGridElement.innerHTML = `<p class="text-center" style="color: var(--text-secondary); grid-column: 1 / -1;">No hay series disponibles.</p>`;
                     }
                } catch (error) {
                    console.error('Error cargando series:', error);
                    showError(`Error al cargar series: ${error.message}`, [{ text: "Reintentar", action: loadSeries }]);
                    seriesData = [];
                    renderSeriesList([]); // Mostrar lista vacía
                } finally {
                    hideLoading();
                }
            }

            function renderSeriesList(seriesArray) {
                 if (!seriesGridElement) return;
                 seriesGridElement.innerHTML = ''; // Limpiar
                 if (!seriesArray || seriesArray.length === 0) {
                     seriesGridElement.innerHTML = `<p class="text-center" style="color: var(--text-secondary); grid-column: 1 / -1;">No hay series disponibles.</p>`;
                     return;
                 }
                 const fragment = document.createDocumentFragment();
                 seriesArray.forEach((serie, index) => {
                     if (!serie || !serie.tituloSerie) return; // Saltar series inválidas

                     const card = document.createElement('div');
                     card.className = 'item-card';
                     card.dataset.seriesIndex = index;

                     const img = document.createElement('img');
                     const placeholderText = encodeURIComponent((serie.tituloSerie || '?').charAt(0));
                     img.src = serie.imagen || `https://placehold.co/200x300/383838/aaaaaa?text=${placeholderText}`;
                     img.alt = ''; // Decorativo
                     img.onerror = () => { img.src = `https://placehold.co/200x300/383838/aaaaaa?text=${placeholderText}`; img.alt = `Placeholder ${serie.tituloSerie}`; };
                     img.loading = 'lazy';

                     const textContent = document.createElement('div');
                     textContent.className = 'text-content';
                     const title = document.createElement('h3');
                     title.textContent = serie.tituloSerie;
                     textContent.appendChild(title);

                     card.appendChild(img);
                     card.appendChild(textContent);

                     card.addEventListener('click', () => {
                         // CORREGIDO: Usar el ID de la vista del reproductor
                         navigateTo('playerView', { type: 'series', index: index });
                     });

                     fragment.appendChild(card);
                 });
                 seriesGridElement.appendChild(fragment);
             }


            // --- Películas ---
            async function loadMovies() {
                showLoading("Cargando películas...");
                moviesGridElement.innerHTML = ''; // Limpiar grid
                try {
                    const response = await fetch(MOVIES_JSON_URL, { cache: "no-store", headers: { 'Accept': 'application/json' } });
                    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                    let data = await response.json();
                    if (!Array.isArray(data)) throw new Error("Formato de datos de películas inválido.");
                    moviesData = data; // Asumiendo que todas son películas
                    console.log(`Películas cargadas: ${moviesData.length}`);
                    renderMoviesList(moviesData);
                     if (moviesData.length === 0) {
                         moviesGridElement.innerHTML = `<p class="text-center" style="color: var(--text-secondary); grid-column: 1 / -1;">No hay películas disponibles.</p>`;
                     }
                } catch (error) {
                    console.error('Error cargando películas:', error);
                    showError(`Error al cargar películas: ${error.message}`, [{ text: "Reintentar", action: loadMovies }]);
                    moviesData = [];
                    renderMoviesList([]); // Mostrar lista vacía
                } finally {
                    hideLoading();
                }
            }

             function renderMoviesList(moviesArray) {
                 if (!moviesGridElement) return;
                 moviesGridElement.innerHTML = ''; // Limpiar
                 if (!moviesArray || moviesArray.length === 0) {
                     moviesGridElement.innerHTML = `<p class="text-center" style="color: var(--text-secondary); grid-column: 1 / -1;">No hay películas disponibles.</p>`;
                     return;
                 }
                 const fragment = document.createDocumentFragment();
                 moviesArray.forEach((movie, index) => {
                     if (!movie || !movie.titulo || !movie.urlDrive) return; // Saltar inválidos

                     const card = document.createElement('div');
                     card.className = 'item-card';
                     card.dataset.movieIndex = index;

                     const img = document.createElement('img');
                     const placeholderText = encodeURIComponent((movie.titulo || '?').charAt(0));
                     img.src = movie.imagen || `https://placehold.co/200x300/383838/aaaaaa?text=${placeholderText}`;
                     img.alt = ''; // Decorativo
                     img.onerror = () => { img.src = `https://placehold.co/200x300/383838/aaaaaa?text=${placeholderText}`; img.alt = `Placeholder ${movie.titulo}`; };
                     img.loading = 'lazy';

                     const textContent = document.createElement('div');
                     textContent.className = 'text-content';
                     const title = document.createElement('h3');
                     title.textContent = movie.titulo;
                     textContent.appendChild(title);

                     card.appendChild(img);
                     card.appendChild(textContent);

                     card.addEventListener('click', () => {
                         // CORREGIDO: Usar el ID de la vista del reproductor
                         navigateTo('playerView', { type: 'movie', index: index });
                     });

                     fragment.appendChild(card);
                 });
                 moviesGridElement.appendChild(fragment);
             }


            // --- Lógica del Reproductor ---

            function setupPlayerView(data) {
                 console.log("Configurando vista de reproductor para:", data);
                 stopPlayback(); // Detener cualquier reproducción anterior

                 playerContentTitle.textContent = 'Cargando...';
                 playerContentDescription.textContent = '';
                 playerFavoriteButton.style.display = 'none';
                 playerSeriesSelectors.style.display = 'none';
                 hlsPlayerElement.style.display = 'none';
                 drivePlayerElement.style.display = 'none';
                 showMessageInPlayer("Cargando...");

                 if (data.type === 'tv') {
                     const channelIndex = data.index;
                     if (channelIndex >= 0 && channelIndex < tvChannels.length) {
                         const channel = tvChannels[channelIndex];
                         currentPlayingTvChannelIndex = channelIndex;
                         playerContentTitle.textContent = channel.title || 'Canal Desconocido';
                         playerContentDescription.textContent = channel.description || '';
                         setupTvPlayerControls(channelIndex);
                         playHlsStream(channel.url, channelIndex);
                         highlightPlayingChannel(channelIndex, tvChannelListElement);
                         highlightPlayingChannel(channelIndex, favoritesChannelListElement);
                     } else {
                         showError("Error: Índice de canal de TV inválido.");
                         navigateTo(previousView || 'mainMenuView');
                     }
                 } else if (data.type === 'series') {
                     const seriesIndex = data.index;
                     if (seriesIndex >= 0 && seriesIndex < seriesData.length) {
                         const serie = seriesData[seriesIndex];
                         currentPlayingSeries = { seriesIndex: seriesIndex, seasonNumber: null, episodeIndex: null };
                         playerContentTitle.textContent = serie.tituloSerie || 'Serie Desconocida';
                         playerContentDescription.textContent = serie.descripcion || '';
                         setupSeriesPlayerControls(serie);
                         // No reproducir nada hasta que se seleccione episodio
                         showMessageInPlayer("Selecciona temporada y episodio");
                     } else {
                         showError("Error: Índice de serie inválido.");
                         navigateTo(previousView || 'mainMenuView');
                     }
                 } else if (data.type === 'movie') {
                     const movieIndex = data.index;
                     if (movieIndex >= 0 && movieIndex < moviesData.length) {
                         const movie = moviesData[movieIndex];
                         currentPlayingMovieIndex = movieIndex;
                         playerContentTitle.textContent = movie.titulo || 'Película Desconocida';
                         playerContentDescription.textContent = movie.descripcion || '';
                         // No hay controles específicos para películas por ahora
                         playDriveStream(movie.urlDrive);
                     } else {
                         showError("Error: Índice de película inválido.");
                         navigateTo(previousView || 'mainMenuView');
                     }
                 } else {
                     console.error("Tipo de contenido desconocido para el reproductor:", data.type);
                     showError("Error: No se puede reproducir este tipo de contenido.");
                     navigateTo(previousView || 'mainMenuView');
                 }
             }

            function setupTvPlayerControls(channelIndex) {
                 playerFavoriteButton.style.display = 'flex'; // Mostrar botón fav
                 playerSeriesSelectors.style.display = 'none'; // Ocultar selectores serie

                 const isFav = tvFavorites.includes(channelIndex.toString());
                 playerFavoriteButton.classList.toggle('is-favorite', isFav);
                 playerFavoriteButton.setAttribute('aria-label', isFav ? 'Quitar de favoritos' : 'Añadir a favoritos');
                 playerFavoriteButton.onclick = () => toggleTvFavorite(channelIndex); // Asignar evento
             }

            function setupSeriesPlayerControls(serie) {
                 playerFavoriteButton.style.display = 'none'; // Ocultar botón fav
                 playerSeriesSelectors.style.display = 'flex'; // Mostrar selectores

                 // Limpiar selectores
                 seasonSelector.innerHTML = '<option value="">Temporada</option>';
                 episodeSelector.innerHTML = '<option value="">Episodio</option>';
                 episodeSelector.disabled = true;

                 if (!serie.temporadas || serie.temporadas.length === 0) {
                     seasonSelector.innerHTML = '<option value="">No hay temporadas</option>';
                     seasonSelector.disabled = true;
                     return;
                 }

                 // Llenar selector de temporadas
                 serie.temporadas.sort((a, b) => (a.numeroTemporada || 0) - (b.numeroTemporada || 0));
                 serie.temporadas.forEach(temp => {
                     if (typeof temp.numeroTemporada !== 'undefined') {
                         const option = document.createElement('option');
                         option.value = temp.numeroTemporada;
                         option.textContent = `Temporada ${temp.numeroTemporada}`;
                         seasonSelector.appendChild(option);
                     }
                 });
                 seasonSelector.disabled = false;

                 // Evento cambio de temporada
                 seasonSelector.onchange = () => {
                     const selectedSeasonNum = seasonSelector.value;
                     episodeSelector.innerHTML = '<option value="">Episodio</option>'; // Limpiar episodios
                     episodeSelector.disabled = true;
                     // Asegurarse que currentPlayingSeries existe
                     if (!currentPlayingSeries) currentPlayingSeries = {};
                     currentPlayingSeries.seasonNumber = selectedSeasonNum ? parseInt(selectedSeasonNum) : null;
                     currentPlayingSeries.episodeIndex = null; // Resetear episodio
                     stopPlayback(); // Detener si algo se estaba reproduciendo
                     showMessageInPlayer("Selecciona un episodio");

                     if (selectedSeasonNum) {
                         const selectedSeason = serie.temporadas.find(t => t.numeroTemporada == selectedSeasonNum);
                         if (selectedSeason && selectedSeason.episodios && selectedSeason.episodios.length > 0) {
                             selectedSeason.episodios.forEach((ep, index) => {
                                 if (ep.tituloEpisodio && ep.urlDrive) {
                                     const option = document.createElement('option');
                                     option.value = index; // Guardar índice del episodio
                                     option.textContent = `${index + 1}. ${ep.tituloEpisodio}`;
                                     episodeSelector.appendChild(option);
                                 }
                             });
                             episodeSelector.disabled = false;
                         } else {
                              episodeSelector.innerHTML = '<option value="">No hay episodios</option>';
                         }
                     }
                 };

                 // Evento cambio de episodio
                 episodeSelector.onchange = () => {
                     const selectedEpisodeIndex = episodeSelector.value;
                     const selectedSeasonNum = seasonSelector.value;
                     // Asegurarse que currentPlayingSeries existe
                     if (!currentPlayingSeries) currentPlayingSeries = {};
                     currentPlayingSeries.episodeIndex = selectedEpisodeIndex ? parseInt(selectedEpisodeIndex) : null;

                     if (selectedSeasonNum && selectedEpisodeIndex !== "") {
                         const selectedSeason = serie.temporadas.find(t => t.numeroTemporada == selectedSeasonNum);
                         if (selectedSeason && selectedSeason.episodios[selectedEpisodeIndex]) {
                             const episode = selectedSeason.episodios[selectedEpisodeIndex];
                             playDriveStream(episode.urlDrive);
                             // Actualizar título y desc para el episodio
                             playerContentTitle.textContent = `${serie.tituloSerie} - T${selectedSeasonNum} E${parseInt(selectedEpisodeIndex) + 1}`;
                             playerContentDescription.textContent = episode.tituloEpisodio || '';
                         } else {
                             showError("Error: No se encontró el episodio seleccionado.");
                             stopPlayback();
                         }
                     } else {
                         stopPlayback(); // Detener si se deselecciona un episodio
                         showMessageInPlayer("Selecciona un episodio");
                         // Restaurar título/desc de la serie
                         playerContentTitle.textContent = serie.tituloSerie || 'Serie Desconocida';
                         playerContentDescription.textContent = serie.descripcion || '';
                     }
                 };
             }

            function playHlsStream(url, channelIndex) {
                 if (!Hls.isSupported()) {
                     // Intentar reproducción nativa si es soportada (iOS)
                     if (hlsPlayerElement.canPlayType('application/vnd.apple.mpegurl')) {
                         console.log("Usando HLS nativo (iOS?)");
                         hlsPlayerElement.src = url;
                         hlsPlayerElement.style.display = 'block';
                         drivePlayerElement.style.display = 'none';
                         hideMessageInPlayer();
                         hlsPlayerElement.play().catch(e => {
                             console.error("Error HLS nativo:", e);
                             showError(`Error al reproducir (nativo): ${e.message}`);
                             updateTvChannelStatus(channelIndex, 'offline');
                         });
                         // Listener para estado online (puede ser menos fiable en nativo)
                         hlsPlayerElement.removeEventListener('playing', handleHlsPlaying); // Limpiar anterior
                         hlsPlayerElement.addEventListener('playing', handleHlsPlaying, { once: true });
                     } else {
                         showError("HLS no es soportado por este navegador.");
                         updateTvChannelStatus(channelIndex, 'offline');
                         return;
                     }
                 } else {
                     console.log("Usando HLS.js");
                     if (hlsInstance) {
                         hlsInstance.destroy();
                     }
                     hlsInstance = new Hls({ /* enableWorker: false // Probar si hay problemas */ });
                     hlsInstance.loadSource(url);
                     hlsInstance.attachMedia(hlsPlayerElement);
                     hlsPlayerElement.style.display = 'block';
                     drivePlayerElement.style.display = 'none';

                     hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                         console.log("HLS Manifest parsed");
                         hideMessageInPlayer();
                         hlsPlayerElement.play().catch(e => {
                             console.error("Error al iniciar play HLS:", e);
                             showError(`Error al reproducir: ${e.message}`);
                             updateTvChannelStatus(channelIndex, 'offline');
                         });
                     });

                     hlsInstance.on(Hls.Events.ERROR, (event, data) => {
                         console.error('HLS Error:', event, data);
                         if (data.fatal) {
                             let errorMsg = `Error HLS (${data.details}).`;
                             if (data.type === Hls.ErrorTypes.NETWORK_ERROR) errorMsg = `Error de red (${data.details}).`;
                             else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) errorMsg = `Error de video (${data.details}).`;
                             showError(errorMsg, [
                                 { text: "Reintentar", action: () => playHlsStream(url, channelIndex) },
                                 { text: "Ver Lista", action: () => navigateTo('tvListView') }
                             ]);
                             updateTvChannelStatus(channelIndex, 'offline');
                             stopPlayback(); // Detener y mostrar mensaje
                             showMessageInPlayer("Error al cargar canal");
                         }
                     });

                     // Listener para estado online
                     hlsPlayerElement.removeEventListener('playing', handleHlsPlaying); // Limpiar anterior
                     hlsPlayerElement.addEventListener('playing', handleHlsPlaying, { once: true });
                 }
                 // Listener común para errores del elemento video
                 hlsPlayerElement.removeEventListener('error', handleVideoElementError);
                 hlsPlayerElement.addEventListener('error', handleVideoElementError);
             }

            // Handler separado para el evento 'playing'
            function handleHlsPlaying() {
                 console.log("HLS playing event fired");
                 if (currentPlayingTvChannelIndex !== null) {
                     updateTvChannelStatus(currentPlayingTvChannelIndex, 'online');
                 }
             }
            // Handler separado para errores del elemento <video>
            function handleVideoElementError(e) {
                 console.error("Error en elemento <video>:", e);
                 const channelIndex = currentPlayingTvChannelIndex; // Capturar índice actual
                 showError("Error al cargar el video.", [
                     // No ofrecer reintentar aquí, ya que es error del elemento
                     { text: "Ver Lista", action: () => navigateTo('tvListView') }
                 ]);
                 if (channelIndex !== null) {
                     updateTvChannelStatus(channelIndex, 'offline');
                 }
                 stopPlayback();
                 showMessageInPlayer("Error al cargar canal");
             }


            function playDriveStream(url) {
                 let cleanUrl = url || '';
                 // Asegurar que la URL está en formato /preview
                 if (cleanUrl.includes('/file/d/')) {
                     const match = cleanUrl.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                     if (match && match[1]) {
                         cleanUrl = `https://drive.google.com/file/d/${match[1]}/preview`;
                     } else {
                         cleanUrl = ''; // URL inválida
                     }
                 } else if (cleanUrl.includes('/preview')) {
                    // Ya está bien, asegurarse que no hay parámetros extra
                    cleanUrl = cleanUrl.substring(0, cleanUrl.indexOf('/preview') + '/preview'.length);
                 } else {
                    cleanUrl = ''; // Formato no reconocido
                 }


                 if (!cleanUrl) {
                     showError("URL de Google Drive inválida.");
                     showMessageInPlayer("Error: URL inválida");
                     return;
                 }

                 console.log(`Reproduciendo Drive: ${cleanUrl}`);
                 drivePlayerElement.src = cleanUrl;
                 drivePlayerElement.style.display = 'block';
                 hlsPlayerElement.style.display = 'none';
                 hideMessageInPlayer();
                 // No hay evento 'playing' fiable para iframes, asumimos que funciona si la URL es válida
             }

            function stopPlayback() {
                 console.log("Deteniendo reproducción");
                 // Detener HLS
                 if (hlsInstance) {
                     hlsInstance.destroy();
                     hlsInstance = null;
                 }
                 if (hlsPlayerElement) {
                     hlsPlayerElement.pause();
                     hlsPlayerElement.removeAttribute('src');
                     hlsPlayerElement.load(); // Forza la recarga/limpieza
                     hlsPlayerElement.style.display = 'none';
                     hlsPlayerElement.removeEventListener('playing', handleHlsPlaying);
                     hlsPlayerElement.removeEventListener('error', handleVideoElementError);
                 }
                 // Detener Drive
                 if (drivePlayerElement) {
                     drivePlayerElement.src = 'about:blank';
                     drivePlayerElement.style.display = 'none';
                 }
                 // Limpiar estado
                 currentPlayingTvChannelIndex = null;
                 currentPlayingSeries = null;
                 currentPlayingMovieIndex = null;
                 // Limpiar resaltado en listas
                 highlightPlayingChannel(null, tvChannelListElement);
                 highlightPlayingChannel(null, favoritesChannelListElement);
                 // No mostrar mensaje aquí, se hará al configurar la nueva vista o player
            }

            function showMessageInPlayer(message = "") {
                 if (playerMessageElement) {
                     playerMessageElement.textContent = message;
                     playerMessageElement.style.display = message ? 'block' : 'none';
                 }
                 // Ocultar reproductores cuando hay mensaje
                 if(hlsPlayerElement) hlsPlayerElement.style.display = 'none';
                 if(drivePlayerElement) drivePlayerElement.style.display = 'none';
            }

            function hideMessageInPlayer() {
                 if (playerMessageElement) {
                     playerMessageElement.style.display = 'none';
                 }
                 // No mostrar reproductores aquí, se hace en playHlsStream/playDriveStream
            }

            // --- Favoritos TV ---
            function toggleTvFavorite(channelIndex) {
                 if (channelIndex === null || channelIndex < 0 || channelIndex >= tvChannels.length) return;
                 const indexString = channelIndex.toString();
                 const favIndex = tvFavorites.indexOf(indexString);

                 if (favIndex > -1) {
                     tvFavorites.splice(favIndex, 1); // Quitar
                     console.log(`Canal TV ${channelIndex} quitado de favoritos`);
                 } else {
                     tvFavorites.push(indexString); // Añadir
                     console.log(`Canal TV ${channelIndex} añadido a favoritos`);
                 }
                 localStorage.setItem('favoritesTvChannelsCar', JSON.stringify(tvFavorites));

                 // Actualizar UI (botón en player y lista de favoritos si está visible)
                 updateFavoriteButtonUI(channelIndex);
                 if (document.getElementById('favoritesListView')?.classList.contains('active')) { // CORREGIDO: Usar ID
                     renderFavoritesList();
                 }
                 // Opcional: Re-renderizar lista principal si se quiere orden por favoritos
                 // if (document.getElementById('tvListView')?.classList.contains('active')) { // CORREGIDO: Usar ID
                 //     filterAndRenderTvChannels();
                 // }
             }

            function updateFavoriteButtonUI(channelIndex) {
                 // CORREGIDO: Usar ID de la vista
                 if (currentView === 'playerView' && currentPlayingTvChannelIndex === channelIndex) {
                     const isFav = tvFavorites.includes(channelIndex.toString());
                     playerFavoriteButton.classList.toggle('is-favorite', isFav);
                     playerFavoriteButton.setAttribute('aria-label', isFav ? 'Quitar de favoritos' : 'Añadir a favoritos');
                 }
             }

            // --- Event Listeners ---
            backButton.addEventListener('click', () => {
                // Lógica de volver atrás:
                // Si estamos en el player -> ir a la vista anterior (lista)
                // Si estamos en una lista -> ir al menú principal
                 // CORREGIDO: Usar ID de la vista
                if (currentView === 'playerView' && previousView) {
                    navigateTo(previousView);
                } else if (currentView !== 'mainMenuView') {
                    navigateTo('mainMenuView');
                }
            });

            // Listeners para botones del menú principal
            document.querySelectorAll('#mainMenuView .menu-button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetViewId = button.dataset.targetView;
                    if (targetViewId) {
                        navigateTo(targetViewId);
                    }
                });
            });

            // Listener para búsqueda en TV
            if (tvSearchButton && tvSearchInput) {
                 tvSearchButton.addEventListener('click', filterAndRenderTvChannels);
                 tvSearchInput.addEventListener('keyup', (e) => {
                     if (e.key === 'Enter') {
                         filterAndRenderTvChannels();
                         tvSearchInput.blur(); // Ocultar teclado
                     } else {
                         // Podrías añadir un debounce aquí si quieres filtrar mientras se escribe
                     }
                 });
                 // Limpiar búsqueda si se borra el texto
                 tvSearchInput.addEventListener('input', () => {
                    if(tvSearchInput.value === '') {
                        filterAndRenderTvChannels();
                    }
                 });
             } else {
                 console.warn("Elementos de búsqueda de TV no encontrados.");
             }

            // Listener para cerrar overlay de error
            closeErrorCarButton.addEventListener('click', hideError);


            // --- Inicialización ---
            function initializeApp() {
                console.log("Inicializando aplicación táctil...");
                navigateTo('mainMenuView'); // Empezar en el menú principal
                // Carga inicial de TV (se hace al navegar a la vista)
                // Las demás listas se cargan bajo demanda
            }

            initializeApp();

        }); // Fin DOMContentLoaded
    } catch (globalError) {
        console.error("Error global irrecuperable:", globalError);
        document.body.innerHTML = `<div style="color: red; background: #111; padding: 30px; text-align: center; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;"><h1>Error Crítico</h1><p>La aplicación no pudo iniciar.</p><p style="margin-top: 10px; font-size: 0.9em;">${globalError.message}</p></div>`;
    }
    </script>

</body>
</html>
